//millis() : get the time in miliseconds since the start of the device
#define BLYNK_PRINT Serial
#define BLYNK_TEMPLATE_ID "TMPL6uG2NY6z1"
#define BLYNK_TEMPLATE_NAME "test1"
#define BLYNK_AUTH_TOKEN  "OxlQZS9cGrxKGJuKl5kWHptMTkxwjIvS"
#define LED_PIN LED_BUILTIN //the pin connected to the LED
#include <BlynkSimpleEsp32.h>
bool alarmEnabled = false;
bool alarmTriggered = false;
bool testTriggered=false;
unsigned long now;
 long remaining;
unsigned long waketime;//time cant be negative
int averagebpm;
BlynkTimer timer; 
String sleepstate;
void myTimer() 
{
  Blynk.virtualWrite(V2, alarmEnabled);  //update the working state of the alarm
  //Blynk.virtualWrite(V3, averagebpm); //send the average bpm
  //Blynk.virtualWrite(V1,sleepstate); //send the sleep state : deep/ narrow
}



BLYNK_WRITE(V0){ //event based , every time the slider is touched, we assign a new wakeup time
  double hoursinput =param.asDouble();
 waketime = millis() + hoursinput*60UL*60UL*1000UL;
 alarmEnabled = true;
 alarmTriggered=false;
 testTriggered = false;
}
BLYNK_WRITE(V4) { // cancel button
  int choice = param.asInt();

  if (choice == 1) {
    alarmEnabled   = false;
    alarmTriggered = false;
    testTriggered  = false;

    // auto reset switch to mimic push button
    Blynk.virtualWrite(V4, 0);
  }
}
void setup() {
Serial.begin(115200);
Blynk.begin(BLYNK_AUTH_TOKEN,"wifiname","wifipass");
  // put your setup code here, to run once:
  timer.setInterval(500L, myTimer);
}

void loop() {
  // put your main code here, to run repeatedly:
Blynk.run();
timer.run();
if(!alarmEnabled){return;}
now = millis();
remaining = long(waketime - now);
if(remaining <= 15UL*60UL*1000UL && !testTriggered){
  ////sleep state test logic coding bla bla
  testTriggered=true;
  alarmTriggered=true;//wake up immediately after testing
}
if(remaining <=0 && alarmTriggered == false){
  //send code to the waking up device
  alarmTriggered = true;
  alarmEnabled = false; //turn off the device after each session  
}
}